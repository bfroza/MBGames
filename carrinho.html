<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrinho de Compras</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="shortcut icon" href="img/carrinho-de-compras.png" type="image/x-icon">
  <link
    href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <header>
    <a href="jogos.php">
      <img src="img/seta-para-a-esquerda.png" alt="" height="50px" width="50px">
    </a>
    <span>Carrinho de compras do <b>MB</b></span>
  </header>
  <main>
    <div class="page-title">Seu Carrinho</div>
    <div class="content">
      <section>
        <table>
          <thead>
            <tr>
              <th>Nome do Jogo</th>
              <th>Preço</th>
              <th>Quantidade</th>
              <th>Total</th>
              <th>-</th>
            </tr>
          </thead>
          <tbody>
            <?php
            include("conexao.php");

            $loginResult = ""; 
            $logado = false;
            if ($_SERVER["REQUEST_METHOD"] == "POST") {
                $user = trim($_POST['user']);
                $senha = trim($_POST['senha']);

                $sql = "SELECT * FROM usuarios WHERE user= '$user' AND senha = '$senha'";
                $result = mysqli_query($conexao, $sql);
                if (mysqli_num_rows($result) == 1){
                    $loginResult = "success";
                    header("Location: index.php");
                    $logado = true;
                    exit;
                }
                else{
                }
            }

            $sql_select = "SELECT nome, desenvolvedor, anoLancamento, Nomecategoria, NomeFornecedor, valor, ImagemDoJogo, quantidade FROM `visu_jogos`";
            $result = mysqli_query($conexao, $sql_select);

            if ($result) {
                while ($row = mysqli_fetch_assoc($result)) {
                    // Calcula o total para cada jogo
                    $total = $row['valor'] * $_POST['quantidade'];

                    echo '<tr>';
                    echo '<td>';
                    echo '<div class="product">';
                    echo '<img src="' . $row['ImagemDoJogo'] . '" alt="" />';
                    echo '<div class="info">';
                    echo '<div class="name">' . $row['nome'] . '</div>';
                    echo '<div class="category">' . $row['Nomecategoria'] . '</div>';
                    echo '</div>';
                    echo '</div>';
                    echo '</td>';
                    echo '<td>R$ ' . number_format($row['valor'], 2, ',', '.') . '</td>';
                    echo '<td>';
                    echo '<div class="qty">';
                    echo '<button class="decrement"><i class="bx bx-minus"></i></button>';
                    echo '<span class="quantity">' . $_POST['quantidade'] . '</span>';
                    echo '<button class="increment"><i class="bx bx-plus"></i></button>';
                    echo '</div>';
                    echo '</td>';
                    echo '<td>R$ ' . number_format($total, 2, ',', '.') . '</td>';
                    echo '<td>';
                    echo '<button class="remove"><i class="bx bx-x"></i></button>';
                    echo '</td>';
                    echo '</tr>';
                }

                mysqli_free_result($result);
            } else {
                echo "Erro ao recuperar jogos do banco de dados: " . mysqli_error($conexao);
            }

            mysqli_close($conexao);
            ?>
          </tbody>
        </table>
      </section>
      <aside>
        <div class="box">
          <header>Resumo da compra</header>
          <div class="info">
            <?php
            // Calcula o subtotal da compra com base nos totais de cada jogo
            $subtotal = 0;
            foreach ($result as $row) {
                $subtotal += $row['valor'] * $_POST['quantidade'];
            }
            ?>

            <div><span>Sub-total</span><span>R$ <?php echo number_format($subtotal, 2, ',', '.'); ?></span></div>
            
            <div>
              <button>
                <form action="desconto.php" method="post">
                  <input type="text" placeholder="Adicionar cupom de desconto">
                  <i class="bx bx-right-arrow-alt"></i>
                </form>
              </button>
            </div>
          </div>
          <footer>
            <span>Total</span>
            <span>R$ <?php echo number_format($subtotal, 2, ',', '.'); ?></span>
          </footer>
        </div>
        <button>Finalizar Compra</button>
      </aside>
    </div>
  </main>

  <script>
    // Pega todos os elementos com classe "qty"
    const qtyContainers = document.querySelectorAll('.qty');

    // Adiciona um evento de clique aos botões de decremento e incremento
    qtyContainers.forEach((container) => {
      const decrementBtn = container.querySelector('.decrement');
      const incrementBtn = container.querySelector('.increment');
      const quantityElement = container.querySelector('.quantity');

      decrementBtn.addEventListener('click', () => {
        let currentQuantity = parseInt(quantityElement.textContent);
        if (currentQuantity > 1) {
          currentQuantity--;
          quantityElement.textContent = currentQuantity;
        }
      });

      incrementBtn.addEventListener('click', () => {
        let currentQuantity = parseInt(quantityElement.textContent);
        currentQuantity++;
        quantityElement.textContent = currentQuantity;
      });
    });
  </script>
</body>
</html>
